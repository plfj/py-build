name: Android Builds

on:
  workflow_dispatch:

jobs:
  build-android-313:
    name: Android (aarch64) Python 3.13
    runs-on: macos-14
    timeout-minutes: 60
    env:
      CC: clang
      CXX: clang++
      LD: clang
      AR: llvm-ar
      NM: llvm-nm
      RANLIB: llvm-ranlib
    steps:
      - name: Install dependencies & clone CPython
        run: |
          brew install readline llvm lld dpkg mpdecimal
          brew uninstall gcc || true
          export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
          git clone --branch 3.13 --depth 1 https://github.com/python/cpython.git cpython-3.13
          ls cpython-3.13

      - name: Apply patch from URL
        run: |
          cd cpython-3.13
          curl -L https://github.com/zrsx-dev/python-build-patch/raw/refs/heads/main/termux.patch -o termux.patch
          curl -L https://github.com/zrsx-dev/python-build-patch/raw/refs/heads/main/as13.patch -o as13.patch
          patch -p1 < termux.patch
          patch -p1 < as13.patch

      - name: Run android.py
        run: |
          cd cpython-3.13
          ./android.py

      - name: Package .deb
        run: |
          PKG_NAME=pyv313
          PKG_VERSION=3.13
          ARCH=aarch64
          BUILD_DIR=$PWD/cpython-3.13/build
          OUT_DIR=$( [ -d "$BUILD_DIR/prefix" ] && echo "$BUILD_DIR/prefix" || echo "$BUILD_DIR/install" )
          DEB_DIR=$PWD/${PKG_NAME}_${PKG_VERSION}_${ARCH}
          mkdir -p $DEB_DIR/DEBIAN
          mkdir -p $DEB_DIR/usr
          cp -r $OUT_DIR/* $DEB_DIR/usr/
          cat > $DEB_DIR/DEBIAN/control <<'EOF'
Package: pyv313
Version: 3.13
Architecture: aarch64
Maintainer: Cross-compiled by NotFound
Description: Python 3.13 cross-compiled for Termux aarch64
EOF
          cat > $DEB_DIR/DEBIAN/postinst <<'EOF'
#!/bin/sh
ln -sf /usr/bin/python3.13 /usr/bin/python3 || true
EOF
          chmod 755 $DEB_DIR/DEBIAN/postinst
          dpkg-deb --build $DEB_DIR
          mv ${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb pyv313_3.13_aarch64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: pyv313_3.13_aarch64
          path: pyv313_3.13_aarch64.deb

  build-android-314:
    name: Android (aarch64) Python 3.14
    runs-on: macos-14
    timeout-minutes: 60
    env:
      CC: clang
      CXX: clang++
      LD: clang
      AR: llvm-ar
      NM: llvm-nm
      RANLIB: llvm-ranlib
    steps:
      - name: Install dependencies & clone CPython
        run: |
          brew install readline llvm lld dpkg mpdecimal
          brew uninstall gcc || true
          export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
          git clone --branch 3.14 --depth 1 https://github.com/python/cpython.git cpython-3.14
          ls cpython-3.14

      - name: Apply patch from URL
        run: |
          cd cpython-3.14
          curl -L https://github.com/zrsx-dev/python-build-patch/raw/refs/heads/main/as14.patch -o as14.patch
          patch -p1 < as14.patch

      - name: Run android.py
        run: |
          cd cpython-3.14
          ./android.py

      - name: Package .deb
        run: |
          PKG_NAME=pyv314
          PKG_VERSION=3.14
          ARCH=aarch64
          BUILD_DIR=$PWD/cpython-3.14/build
          OUT_DIR=$( [ -d "$BUILD_DIR/prefix" ] && echo "$BUILD_DIR/prefix" || echo "$BUILD_DIR/install" )
          DEB_DIR=$PWD/${PKG_NAME}_${PKG_VERSION}_${ARCH}
          mkdir -p $DEB_DIR/DEBIAN
          mkdir -p $DEB_DIR/usr
          cp -r $OUT_DIR/* $DEB_DIR/usr/
          cat > $DEB_DIR/DEBIAN/control <<'EOF'
Package: pyv314
Version: 3.14
Architecture: aarch64
Maintainer: Cross-compiled by NotFound
Description: Python 3.14 cross-compiled for Termux aarch64
EOF
          cat > $DEB_DIR/DEBIAN/postinst <<'EOF'
#!/bin/sh
ln -sf /usr/bin/python3.14 /usr/bin/python3 || true
EOF
          chmod 755 $DEB_DIR/DEBIAN/postinst
          dpkg-deb --build $DEB_DIR
          mv ${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb pyv314_3.14_aarch64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: pyv314_3.14_aarch64
          path: pyv314_3.14_aarch64.deb

  build-android-315:
    name: Android (aarch64) Python 3.15
    runs-on: macos-14
    timeout-minutes: 60
    env:
      CC: clang
      CXX: clang++
      LD: clang
      AR: llvm-ar
      NM: llvm-nm
      RANLIB: llvm-ranlib
    steps:
      - name: Install dependencies & clone CPython
        run: |
          brew install readline llvm lld dpkg mpdecimal
          brew uninstall gcc || true
          export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
          git clone --branch 3.15 --depth 1 https://github.com/python/cpython.git cpython-3.15
          ls cpython-3.15

      - name: Run android.py
        run: |
          cd cpython-3.15
          ./android.py

      - name: Package .deb
        run: |
          PKG_NAME=pyv315
          PKG_VERSION=3.15
          ARCH=aarch64
          BUILD_DIR=$PWD/cpython-3.15/build
          OUT_DIR=$( [ -d "$BUILD_DIR/prefix" ] && echo "$BUILD_DIR/prefix" || echo "$BUILD_DIR/install" )
          DEB_DIR=$PWD/${PKG_NAME}_${PKG_VERSION}_${ARCH}
          mkdir -p $DEB_DIR/DEBIAN
          mkdir -p $DEB_DIR/usr
          cp -r $OUT_DIR/* $DEB_DIR/usr/
          cat > $DEB_DIR/DEBIAN/control <<'EOF'
Package: pyv315
Version: 3.15
Architecture: aarch64
Maintainer: Cross-compiled by NotFound
Description: Python 3.15 cross-compiled for Termux aarch64
EOF
          cat > $DEB_DIR/DEBIAN/postinst <<'EOF'
#!/bin/sh
ln -sf /usr/bin/python3.15 /usr/bin/python3 || true
EOF
          chmod 755 $DEB_DIR/DEBIAN/postinst
          dpkg-deb --build $DEB_DIR
          mv ${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb pyv315_3.15_aarch64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: pyv315_3.15_aarch64
          path: pyv315_3.15_aarch64.deb
